---
title: "rts_data_processing"
output: rmarkdown::html_vignette
author: Jannis Gottwald
vignette: >
  %\VignetteIndexEntry{rts_data_processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
##Introduction

The use of VHF transmitters is still the only option to track the movements of small animals (https://science.sciencemag.org/content/348/6240/aaa2478). However, the method in its manual form is extremely labour-intensive and spatially and temporally poorly resolved. Recent developments allow automation of the recording of VHF signals and thus the spatially and temporally highly resolved observation of even very small animals (https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13294). The data volumes involved are considerable, and efficient data processing is needed. This vignette explains all the steps from the processing of raw data recorded with this [software](https://github.com/Nature40/Sensorboxes-Images/releases/tag/radiotracking-0.4.3) to the triangulations. All necessary functionalities are provided in the [rts R package](https://github.com/Nature40/rts/).  In this Vignette [test data]((https://hessenbox.uni-marburg.de/getlink/fiSz2C9chiQUmj5LmLXyxAzm/data) generated by Kim Lindner and Marcel Becker is used.

##Packages needed

```{r setup, message=FALSE, warning=FALSE }
library(rts)
library(plyr)
library(data.tree)
library(raster)
library(mapview)
library(data.table)

```

## Initialize Project

The package is structured in such a way that a project folder (projroot) is created at the beginning, in which various subfolders for intermediate products and reference data are stored. The initProject function creates these folders as well as a R object in the form of a list in which all paths are stored. In addition, the path to absolute raw data, as created by the [software](https://github.com/Nature40/Sensorboxes-Images/releases/tag/radiotracking-0.4.3), which may be stored on an external hard disk and do not need to be integrated into the project , can be specified in the iniProject function.

```{r eval=FALSE}

plst<-initProject(projroot = "path/project_name/", logger_data_raw = "path/to/raw/data/")
````

the created folder structure looks like this

```{r,results='hide', include=FALSE}
path <- c(
    "projroot/data/batch_awk/", 
    "projroot/data/calibration_curves/", 
    "projroot/data/catalogues/", 
    "proroot/data/correction_values/", 
    "projroot/data/individuals/",
    "projroot/data/kplv/",
    "projroot/data/logger_data_csv/",
    "projroot/data/param_lst/",
    "projroot/data/reference_data/"
    
)


x <- lapply(strsplit(path, "/"), function(z) as.data.frame(t(z)))
x <- rbind.fill(x)
x$pathString <- apply(x, 1, function(x) paste(trimws(na.omit(x)), collapse="/"))
(folder.structure <- data.tree::as.Node(x))
````

```{r}
folder.structure
````
## data that need to be provided
+ Stations.csv: Data.table with Name of the rts station, Coordinates in Lat/Lon and orientation of each antenna of the station. Colnames have to be Name;Longitude;Latitude;receiver;orientation. Should be stored in projroot/data/reference_data/
+ Calibration curves: rts data recorded during a [calibration session](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13294). One file per station and must carry complete station name in file name. Data should be stored in projroot/data/calibration_curves/. Only necessary if calibration is desired (recommended).  


## raw data processing
The following shows how the raw data, as it comes from the software, is processed. The data is located under "path/to/raw/data/" as specified in the initProject function. The folder structure there must look like this:  

```{r,results='hide', include=FALSE}
path <- c(
    "logger_data_raw/NameStation1/collection1/", 
    "logger_data_raw/NameStation1/collection2/",
    "logger_data_raw/NameStation2/collection1/", 
    "logger_data_raw/NameStation2/collection2/",
    "logger_data_raw/NameStation3/collection1/",
    "/.../"
    
    
)


x <- lapply(strsplit(path, "/"), function(z) as.data.frame(t(z)))
x <- rbind.fill(x)
x$pathString <- apply(x, 1, function(x) paste(trimws(na.omit(x)), collapse="/"))
(logger_data_raw <- data.tree::as.Node(x))
````

```{r}
logger_data_raw
````

The name of the station must be exactly the same as in the reference table for the stations (**Station.csv, data that need to be provided**). Collections can be named according to the date of data collection, for example. The data looks like this: for each start time, a .csv is created for each receiver (e.g. 2020-06-09T173044_0.csv for receiver 0) as well as a configuration file for all receivers containing all the parameters set for the run (2020-06-09T173044.conf).

First, a data catalogue is created from the raw data, in which the name of each file and the set parameters are saved. This is done with the help of the function file.catalogue from the rts package. The function gets the location of the raw data from the projList (initProject). The catalogues are created per station and collection and therefore these must be specified,




```{r eval=FALSE}

file.catalogue(projList = plst, station="mof_rts_00009", collection = "duration_test" )
````




